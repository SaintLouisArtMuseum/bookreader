{"version":3,"file":"plugins/plugin.archive_analytics.js","mappings":"mJAUsCA,E,wBAN/BC,OAAOC,WAAWC,eAAgB,CACvCC,wBAAwB,EAExBC,uBAAuB,IAGzBH,WAAWI,UAAUC,MAAiBP,EAQnCE,WAAWI,UAAUC,KAPf,WAAW,WAChBP,EAAOQ,KAAKC,MAERA,KAAKC,QAAQN,wBACfK,KAAKE,KAAKT,WAAWU,WAAWC,gBAAgB,kBAAM,EAAKC,0CAMjEZ,WAAWI,UAAUQ,mCAAqC,WACxD,GAAKC,OAAOC,kBAAZ,CAIA,IAAMC,EAAeR,KAAKK,mCAAmCG,aAEvDC,EAAST,KAAKU,oBACdC,EAAcX,KAAKY,mBAAmBH,GAE5C,GAAID,GAAgBG,EAAa,CAC/B,IAAME,EAAS,CACbC,WAAY,oBACZC,OAAQf,KAAKgB,OACbC,WAAYC,KAAKC,SAGnBN,QAAiB,EACjBA,QAAiB,GACjB,IACEA,EAAOO,QAAUd,OAAOe,IAAIC,SAASC,SAASC,MAAM,kBAChD,EACA,EACJX,EAAOY,SACJZ,EAAOO,SAAWd,OAAOe,IAAIC,SAASI,SAASF,MAAM,gBAClD,EACA,EACN,MAAOG,IAITpB,kBAAkBqB,UAAUf,EAAQ,KAAM,uBAG1C,IAAMgB,EAAwB7B,KAAKC,QAAQ6B,aAAe9B,KAAKC,QAAQ6B,YAAYC,OAC/E,CAAEA,OAAQ/B,KAAKC,QAAQ6B,YAAYC,QACnC,GACJxB,kBAAkByB,WAAW,aAAc,kBAAmB1B,OAAOgB,SAASI,SAAUG,GAExF7B,KAAKK,mCAAmCG,aAAeG,KAW3DlB,WAAWI,UAAUoC,0BAA4B,SAASC,EAAUC,EAAQC,EAAOP,GAC5E7B,KAAKC,QAAQN,yBAEdK,KAAKC,QAAQL,uBACfyC,QAAQC,IAAI,4BAA6BC,UAAWjC,OAAOC,mBAGxDD,OAAOC,oBAEZsB,EAAwBA,GAAyB,GAC5B,iBAAVO,IACTP,EAAsBW,GAAKJ,GAE7B9B,OAAOC,kBAAkByB,WAAWE,EAAUC,EAAQ,KAAMN,O,qBCnF9D,IAAI9B,EAAO,EAAQ,MACf0C,EAAgC,EAAQ,MACxCC,EAAW,EAAQ,MACnBC,EAAW,EAAQ,MACnBC,EAAW,EAAQ,MACnBC,EAAyB,EAAQ,MACjCC,EAAY,EAAQ,MACpBC,EAAqB,EAAQ,MAC7BC,EAAa,EAAQ,MAGzBP,EAA8B,SAAS,SAAUQ,EAAOC,EAAaC,GACnE,MAAO,CAGL,SAAeC,GACb,IAAIC,EAAIR,EAAuB7C,MAC3BsD,EAAoBC,MAAVH,OAAsBG,EAAYT,EAAUM,EAAQH,GAClE,OAAOK,EAAUvD,EAAKuD,EAASF,EAAQC,GAAK,IAAIG,OAAOJ,GAAQH,GAAOL,EAASS,KAIjF,SAAUI,GACR,IAAIC,EAAKhB,EAAS1C,MACd2D,EAAIf,EAASa,GACbG,EAAMT,EAAgBD,EAAaQ,EAAIC,GAE3C,GAAIC,EAAIC,KAAM,OAAOD,EAAIxB,MAEzB,IAAKsB,EAAGI,OAAQ,OAAOd,EAAWU,EAAIC,GAEtC,IAAII,EAAcL,EAAGM,QACrBN,EAAGO,UAAY,EAIf,IAHA,IAEIC,EAFAC,EAAI,GACJC,EAAI,EAEgC,QAAhCF,EAASlB,EAAWU,EAAIC,KAAc,CAC5C,IAAIU,EAAWzB,EAASsB,EAAO,IAC/BC,EAAEC,GAAKC,EACU,KAAbA,IAAiBX,EAAGO,UAAYlB,EAAmBY,EAAGhB,EAASe,EAAGO,WAAYF,IAClFK,IAEF,OAAa,IAANA,EAAU,KAAOD,S","sources":["webpack://@internetarchive/bookreader/./src/plugins/plugin.archive_analytics.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.string.match.js"],"sourcesContent":["/* global BookReader, archive_analytics */\r\n/**\r\n * Plugin for Archive.org analytics\r\n */\r\njQuery.extend(BookReader.defaultOptions, {\r\n  enableArchiveAnalytics: true,\r\n  /** Provide a means of debugging, cause otherwise it's impossible to test locally */\r\n  debugArchiveAnaltyics: false,\r\n});\r\n\r\nBookReader.prototype.init = (function(super_) {\r\n  return function() {\r\n    super_.call(this);\r\n\r\n    if (this.options.enableArchiveAnalytics) {\r\n      this.bind(BookReader.eventNames.fragmentChange, () => this.archiveAnalyticsSendFragmentChange());\r\n    }\r\n  };\r\n})(BookReader.prototype.init);\r\n\r\n/** @private */\r\nBookReader.prototype.archiveAnalyticsSendFragmentChange = function() {\r\n  if (!window.archive_analytics) {\r\n    return;\r\n  }\r\n\r\n  const prevFragment = this.archiveAnalyticsSendFragmentChange.prevFragment;\r\n\r\n  const params = this.paramsFromCurrent();\r\n  const newFragment = this.fragmentFromParams(params);\r\n\r\n  if (prevFragment != newFragment) {\r\n    const values = {\r\n      bookreader: \"user_changed_view\",\r\n      itemid: this.bookId,\r\n      cache_bust: Math.random()\r\n    };\r\n    // EEK!  offsite embedding and /details/ page books look the same in analytics, otherwise!\r\n    values.offsite = 1;\r\n    values.details = 0;\r\n    try {\r\n      values.offsite = window.top.location.hostname.match(/\\.archive.org$/)\r\n        ? 0\r\n        : 1;\r\n      values.details =\r\n        !values.offsite && window.top.location.pathname.match(/^\\/details\\//)\r\n          ? 1\r\n          : 0;\r\n    } catch (e) {}\r\n    // avoids embed cross site exceptions -- but on (+) side, means it is and keeps marked offite!\r\n\r\n    // Send bookreader ping\r\n    archive_analytics.send_ping(values, null, \"augment_for_ao_site\");\r\n\r\n    // Also send tracking event ping\r\n    const additionalEventParams = this.options.lendingInfo && this.options.lendingInfo.loanId\r\n      ? { loanId: this.options.lendingInfo.loanId }\r\n      : {};\r\n    archive_analytics.send_event('BookReader', 'UserChangedView', window.location.pathname, additionalEventParams);\r\n\r\n    this.archiveAnalyticsSendFragmentChange.prevFragment = newFragment;\r\n  }\r\n};\r\n\r\n/**\r\n * Sends a tracking \"Event\". See https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#events\r\n * @param {string} category\r\n * @param {string} action\r\n * @param {number} [value] (must be an int)\r\n * @param {Object} [additionalEventParams]\r\n */\r\nBookReader.prototype.archiveAnalyticsSendEvent = function(category, action, value, additionalEventParams) {\r\n  if (!this.options.enableArchiveAnalytics) return;\r\n\r\n  if (this.options.debugArchiveAnaltyics) {\r\n    console.log(\"archiveAnalyticsSendEvent\", arguments, window.archive_analytics);\r\n  }\r\n\r\n  if (!window.archive_analytics) return;\r\n\r\n  additionalEventParams = additionalEventParams || {};\r\n  if (typeof(value) == 'number') {\r\n    additionalEventParams.ev = value;\r\n  }\r\n  window.archive_analytics.send_event(category, action, null, additionalEventParams);\r\n};\r\n","'use strict';\nvar call = require('../internals/function-call');\nvar fixRegExpWellKnownSymbolLogic = require('../internals/fix-regexp-well-known-symbol-logic');\nvar anObject = require('../internals/an-object');\nvar toLength = require('../internals/to-length');\nvar toString = require('../internals/to-string');\nvar requireObjectCoercible = require('../internals/require-object-coercible');\nvar getMethod = require('../internals/get-method');\nvar advanceStringIndex = require('../internals/advance-string-index');\nvar regExpExec = require('../internals/regexp-exec-abstract');\n\n// @@match logic\nfixRegExpWellKnownSymbolLogic('match', function (MATCH, nativeMatch, maybeCallNative) {\n  return [\n    // `String.prototype.match` method\n    // https://tc39.es/ecma262/#sec-string.prototype.match\n    function match(regexp) {\n      var O = requireObjectCoercible(this);\n      var matcher = regexp == undefined ? undefined : getMethod(regexp, MATCH);\n      return matcher ? call(matcher, regexp, O) : new RegExp(regexp)[MATCH](toString(O));\n    },\n    // `RegExp.prototype[@@match]` method\n    // https://tc39.es/ecma262/#sec-regexp.prototype-@@match\n    function (string) {\n      var rx = anObject(this);\n      var S = toString(string);\n      var res = maybeCallNative(nativeMatch, rx, S);\n\n      if (res.done) return res.value;\n\n      if (!rx.global) return regExpExec(rx, S);\n\n      var fullUnicode = rx.unicode;\n      rx.lastIndex = 0;\n      var A = [];\n      var n = 0;\n      var result;\n      while ((result = regExpExec(rx, S)) !== null) {\n        var matchStr = toString(result[0]);\n        A[n] = matchStr;\n        if (matchStr === '') rx.lastIndex = advanceStringIndex(S, toLength(rx.lastIndex), fullUnicode);\n        n++;\n      }\n      return n === 0 ? null : A;\n    }\n  ];\n});\n"],"names":["super_","extend","BookReader","defaultOptions","enableArchiveAnalytics","debugArchiveAnaltyics","prototype","init","call","this","options","bind","eventNames","fragmentChange","archiveAnalyticsSendFragmentChange","window","archive_analytics","prevFragment","params","paramsFromCurrent","newFragment","fragmentFromParams","values","bookreader","itemid","bookId","cache_bust","Math","random","offsite","top","location","hostname","match","details","pathname","e","send_ping","additionalEventParams","lendingInfo","loanId","send_event","archiveAnalyticsSendEvent","category","action","value","console","log","arguments","ev","fixRegExpWellKnownSymbolLogic","anObject","toLength","toString","requireObjectCoercible","getMethod","advanceStringIndex","regExpExec","MATCH","nativeMatch","maybeCallNative","regexp","O","matcher","undefined","RegExp","string","rx","S","res","done","global","fullUnicode","unicode","lastIndex","result","A","n","matchStr"],"sourceRoot":""}