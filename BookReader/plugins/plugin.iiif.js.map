{"version":3,"file":"plugins/plugin.iiif.js","mappings":"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","sources":["webpack://@internetarchive/bookreader/./src/plugins/plugin.iiif.js"],"sourcesContent":["// @ts-check\r\nconst BookReader = /** @type {typeof import('../BookReader').default} */(window.BookReader);\r\n\r\nexport const DEFAULT_OPTIONS = {\r\n  enabled: true,\r\n  /** @type {import('@iiif/presentation-3').Manifest | import('@iiif/presentation-2').Manifest} */\r\n  manifest: null,\r\n};\r\n\r\nclass IIIFPlugin {\r\n  constructor(options = DEFAULT_OPTIONS, optionVariables) {\r\n    this.options = options;\r\n    this.optionVariables = optionVariables;\r\n    this.manifest = options.manifest;\r\n  }\r\n\r\n  load() {\r\n    if (this.manifest[\"@context\"] == \"http://iiif.io/api/presentation/2/context.json\") {\r\n      const manifest = /** @type {import('@iiif/presentation-2').Manifest} */(this.manifest);\r\n      return this.manifestToBookReaderV2(manifest);\r\n    } else if (this.manifest[\"@context\"] == \"http://iiif.io/api/presentation/3/context.json\") {\r\n      const manifest = /** @type {import('@iiif/presentation-3').Manifest} */(this.manifest);\r\n      return this.manifestToBookReaderV3(manifest);\r\n    } else {\r\n      throw new Error(\"Unsupported IIIF context \" + this.manifest[\"@context\"]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {import('@iiif/presentation-3').Manifest} manifest\r\n   */\r\n  manifestToBookReaderV3(manifest) {\r\n    /** @type {import('../BookReader/options.js').BookReaderOptions} */\r\n    const book = {\r\n      bookTitle: resolveInternationalString(manifest.label),\r\n      pageProgression: manifest.viewingDirection == \"right-to-left\" ? \"rl\" : \"lr\",\r\n      // numLeafs: manifest.items.length,\r\n      metadata: manifest.metadata.map((metadata) => {\r\n        return {\r\n          label: resolveInternationalString(metadata.label),\r\n          value: resolveInternationalString(metadata.value),\r\n        };\r\n      }),\r\n      data: [],\r\n      /**\r\n       * @this {import('../BookReader.js').default}\r\n       */\r\n      getPageURI(pageIndex, reduce, rotate) {\r\n        const percent = Math.floor(100 * 1 / reduce);\r\n        const bodyArr = manifest.items[pageIndex].items[0].items[0].body;\r\n        const body = bodyArr instanceof Array ? bodyArr[0] : bodyArr;\r\n        const uri = body.service[0].id;\r\n        return `${uri}/full/pct:${percent}/0/default.jpg`;\r\n      }\r\n    };\r\n\r\n    if (manifest.viewingDirection == \"top-to-bottom\" || manifest.viewingDirection == \"bottom-to-top\") {\r\n      console.warn(\"Unsupported viewingDirection\", manifest.viewingDirection);\r\n    }\r\n\r\n    let spread = [];\r\n    manifest.items.forEach((item, index) => {\r\n      const bodyArr = manifest.items[index].items[0].items[0].body;\r\n      const body = bodyArr instanceof Array ? bodyArr[0] : bodyArr;\r\n      const uri = body.service[0].id;\r\n      /** @type {import('../BookReader/options.js').PageData} */\r\n      const pageData = {\r\n        uri,\r\n        width: item.width,\r\n        height: item.height,\r\n        pageNum: resolveInternationalString(item.label),\r\n      };\r\n      spread.push(pageData);\r\n      if (index % 2 == 0) {\r\n        book.data.push(spread);\r\n        spread = [];\r\n      }\r\n    });\r\n\r\n    return book;\r\n  }\r\n\r\n  /**\r\n   * @param {import('@iiif/presentation-2').Manifest} manifest\r\n   */\r\n  manifestToBookReaderV2(manifest) {\r\n    /** @type {import('../BookReader/options.js').BookReaderOptions} */\r\n    const book = {\r\n      bookTitle: manifest.label,\r\n      metadata: manifest.metadata,\r\n      thumbnail: manifest.thumbnail?.['@id'],\r\n      // numLeafs: manifest.sequences[0].canvases.length,\r\n      data: [],\r\n      /**\r\n       * @this {import('../BookReader.js').default}\r\n       */\r\n      getPageURI(pageIndex, reduce, rotate) {\r\n        const percent = Math.floor(100 * 1 / reduce);\r\n        const uri = manifest.sequences[0].canvases[pageIndex].images[0].resource.service['@id'];\r\n        return `${uri}/full/pct:${percent}/0/default.jpg`;\r\n      }\r\n    };\r\n\r\n    let spread = [];\r\n    manifest.sequences[0].canvases.forEach((canvas, index) => {\r\n      /** @type {import('../BookReader/options.js').PageData} */\r\n      const pageData = {\r\n        uri: canvas.images[0].resource.service['@id'],\r\n        width: canvas.width,\r\n        height: canvas.height,\r\n        pageNum: canvas.label,\r\n      };\r\n      spread.push(pageData);\r\n      if (index % 2 == 0) {\r\n        book.data.push(spread);\r\n        spread = [];\r\n      }\r\n    });\r\n\r\n    return book;\r\n  }\r\n}\r\n\r\n/**\r\n * @param {import('@iiif/presentation-3').InternationalString} internationalString\r\n */\r\nfunction resolveInternationalString(internationalString) {\r\n  const anyLang = Object.keys(internationalString)[0];\r\n  return (internationalString[navigator.language] || internationalString[anyLang])[0];\r\n}\r\n\r\nexport class BookReaderWithIIIFPlugin extends BookReader {\r\n  setup(options) {\r\n    const pluginOpts = Object.assign(\r\n      {},\r\n      DEFAULT_OPTIONS,\r\n      options.plugins.iiif,\r\n    );\r\n\r\n    if (pluginOpts.enabled) {\r\n      this.iiifPlugin = new IIIFPlugin(pluginOpts, options.vars);\r\n      // Write this back; this way the plugin is the source of truth, and BR just\r\n      // contains a reference to it.\r\n      options.plugins.iiif = this.iiifPlugin.options;\r\n      Object.assign(options, this.iiifPlugin.load());\r\n    }\r\n    return super.setup(options);\r\n  }\r\n}\r\nwindow.BookReader = BookReaderWithIIIFPlugin;\r\nexport default BookReaderWithIIIFPlugin;\r\n"],"names":["BookReader","window","DEFAULT_OPTIONS","enabled","manifest","IIIFPlugin","_createClass","options","arguments","length","undefined","optionVariables","_classCallCheck","this","key","value","manifestToBookReaderV2","manifestToBookReaderV3","Error","book","bookTitle","resolveInternationalString","label","pageProgression","viewingDirection","metadata","map","data","getPageURI","pageIndex","reduce","rotate","percent","Math","floor","bodyArr","items","body","uri","Array","service","id","concat","console","warn","spread","forEach","item","index","pageData","width","height","pageNum","push","_manifest$thumbnail","thumbnail","sequences","canvases","images","resource","canvas","internationalString","anyLang","Object","keys","navigator","language","BookReaderWithIIIFPlugin","_BookReader","_callSuper","_inherits","pluginOpts","assign","plugins","iiif","iiifPlugin","vars","load","_get","_getPrototypeOf","prototype","call"],"sourceRoot":""}