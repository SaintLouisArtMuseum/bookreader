{"version":3,"file":"plugins/plugin.text_selection.js","mappings":"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","sources":["webpack://@internetarchive/bookreader/./src/BookReader/utils/SelectionObserver.js","webpack://@internetarchive/bookreader/./src/util/strings.js","webpack://@internetarchive/bookreader/./src/plugins/plugin.text_selection.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/number-parse-float.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/string-trim-forced.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.parse-float.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.string.trim.js"],"sourcesContent":["// @ts-check\r\nexport class SelectionObserver {\r\n  selecting = false;\r\n  startedInSelector = false;\r\n  /** @type {HTMLElement} */\r\n  target = null;\r\n\r\n  /**\r\n   * @param {string} selector\r\n   * @param {function('started' | 'cleared', HTMLElement): any} handler\r\n   */\r\n  constructor(selector, handler) {\r\n    this.selector = selector;\r\n    this.handler = handler;\r\n  }\r\n\r\n  attach() {\r\n    // We can't just use selectstart, because safari on iOS just\r\n    // randomly decides when to fire it ðŸ˜¤\r\n    // document.addEventListener(\"selectstart\", this._onSelectStart);\r\n    // This has to be on document :/\r\n    document.addEventListener(\"selectionchange\", this._onSelectionChange);\r\n  }\r\n\r\n  detach() {\r\n    document.removeEventListener(\"selectionchange\", this._onSelectionChange);\r\n  }\r\n\r\n  _onSelectionChange = () => {\r\n    const sel = window.getSelection();\r\n\r\n    if (!this.selecting && sel.toString()) {\r\n      this.selecting = true;\r\n      this.target = $(sel.anchorNode).closest(this.selector)[0];\r\n      this.handler('started', this.target);\r\n    }\r\n\r\n    if (this.selecting && (sel.isCollapsed || !sel.toString() || !$(sel.anchorNode).closest(this.selector)[0])) {\r\n      this.selecting = false;\r\n      this.handler('cleared', this.target);\r\n    }\r\n  };\r\n}\r\n","/**\r\n * @typedef {String} StringWithVars\r\n * A template string with {{foo}} style variables\r\n * Also supports filters, like {{bookPath|urlencode}} (See APPLY_FILTERS for the\r\n * supported list of filters)\r\n **/\r\n\r\n/**\r\n * @param {StringWithVars|String} template\r\n * @param { {[varName: string]: { toString: () => string} } } vars\r\n * @param { {[varName: string]: { toString: () => string} } } [overrides]\r\n */\r\nexport function applyVariables(template, vars, overrides = {}, possibleFilters = APPLY_FILTERS) {\r\n  return template?.replace(/\\{\\{([^}]*?)\\}\\}/g, ($0, $1) => {\r\n    if (!$1) return $0;\r\n    /** @type {string} */\r\n    const expression = $1;\r\n    const [varName, ...filterNames] = expression.split('|').map(x => x.trim());\r\n    const defined = varName in overrides || varName in vars;\r\n\r\n    // If it's not defined, don't expand it at all\r\n    if (!defined) return $0;\r\n\r\n    const value = varName in overrides ? overrides[varName]\r\n      : varName in vars ? vars[varName] : null;\r\n    const filters = filterNames.map(n => possibleFilters[n]);\r\n    return filters.reduce((acc, cur) => cur(acc), value && value.toString());\r\n  });\r\n}\r\n\r\n/** @type { {[filterName: String]:( string => string)} } */\r\nexport const APPLY_FILTERS = {\r\n  urlencode: encodeURIComponent,\r\n};\r\n","//@ts-check\r\nimport { createDIVPageLayer } from '../BookReader/PageContainer.js';\r\nimport { SelectionObserver } from '../BookReader/utils/SelectionObserver.js';\r\nimport { applyVariables } from '../util/strings.js';\r\n/** @typedef {import('../util/strings.js').StringWithVars} StringWithVars */\r\n/** @typedef {import('../BookReader/PageContainer.js').PageContainer} PageContainer */\r\n\r\nconst BookReader = /** @type {typeof import('../BookReader').default} */(window.BookReader);\r\n\r\nexport const DEFAULT_OPTIONS = {\r\n  enabled: true,\r\n  /** @type {StringWithVars} The URL to fetch the entire DJVU xml. Supports options.vars */\r\n  fullDjvuXmlUrl: null,\r\n  /** @type {StringWithVars} The URL to fetch a single page of the DJVU xml. Supports options.vars. Also has {{pageIndex}} */\r\n  singlePageDjvuXmlUrl: null,\r\n  /** Whether to fetch the XML as a jsonp */\r\n  jsonp: false,\r\n  override: true,\r\n};/** Add override as hacky way of disabling this plugin. Intended method with 'enabled' and options.js does not work. @TODO Find a clean way to disable text selection.  */\r\n/** @typedef {typeof DEFAULT_OPTIONS} TextSelectionPluginOptions */\r\n\r\n/**\r\n * @template T\r\n */\r\nexport class Cache {\r\n  constructor(maxSize = 10) {\r\n    this.maxSize = maxSize;\r\n    /** @type {T[]} */\r\n    this.entries = [];\r\n  }\r\n\r\n  /**\r\n   * @param {T} entry\r\n   */\r\n  add(entry) {\r\n    if (this.entries.length >= this.maxSize) {\r\n      this.entries.shift();\r\n    }\r\n    this.entries.push(entry);\r\n  }\r\n}\r\n\r\nexport class TextSelectionPlugin {\r\n  /**\r\n   * @param {'lr' | 'rl'} pageProgression In the future this should be in the ocr file\r\n   * since a book being right to left doesn't mean the ocr is right to left. But for\r\n   * now we do make that assumption.\r\n   */\r\n  constructor(options = DEFAULT_OPTIONS, optionVariables, pageProgression = 'lr') {\r\n    this.options = options;\r\n    if (this.options.override === true) return;\r\n    this.optionVariables = optionVariables;\r\n    /**@type {PromiseLike<JQuery<HTMLElement>|undefined>} */\r\n    this.djvuPagesPromise = null;\r\n    /** Whether the book is right-to-left */\r\n    this.rtl = pageProgression === 'rl';\r\n\r\n    /** @type {Cache<{index: number, response: any}>} */\r\n    this.pageTextCache = new Cache();\r\n\r\n    /**\r\n     * Sometimes there are too many words on a page, and the browser becomes near\r\n     * unusable. For now don't render text layer for pages with too many words.\r\n     */\r\n    this.maxWordRendered = 2500;\r\n\r\n    this.selectionObserver = new SelectionObserver('.BRtextLayer', this._onSelectionChange);\r\n  }\r\n\r\n  /**\r\n   * @param {'started' | 'cleared'} type\r\n   * @param {HTMLElement} target\r\n   */\r\n  _onSelectionChange = (type, target) => {\r\n    if (type === 'started') {\r\n      this.textSelectingMode(target);\r\n    } else if (type === 'cleared') {\r\n      this.defaultMode(target);\r\n    } else {\r\n      throw new Error(`Unknown type ${type}`);\r\n    }\r\n  }\r\n\r\n  init() {\r\n    if(this.selectionObserver != null || this.selectionObserver != undefined) { \r\n      this.selectionObserver.attach();\r\n    }\r\n\r\n    // Only fetch the full djvu xml if the single page url isn't there\r\n    if (this.options.singlePageDjvuXmlUrl) return;\r\n    this.djvuPagesPromise = $.ajax({\r\n      type: \"GET\",\r\n      url: applyVariables(this.options.fullDjvuXmlUrl, this.optionVariables),\r\n      dataType: this.options.jsonp ? \"jsonp\" : \"html\",\r\n      cache: true,\r\n      error: (e) => undefined\r\n    }).then((res) => {\r\n      try {\r\n        const xmlMap = $.parseXML(res);\r\n        return xmlMap && $(xmlMap).find(\"OBJECT\");\r\n      } catch (e) {\r\n        return undefined;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {number} index\r\n   * @returns {Promise<HTMLElement|undefined>}\r\n   */\r\n  async getPageText(index) {\r\n    if (this.options.singlePageDjvuXmlUrl && this.options.override === false) {\r\n      const cachedEntry = this.pageTextCache.entries.find(x => x.index == index);\r\n      if (cachedEntry) {\r\n        return cachedEntry.response;\r\n      }\r\n      const res = await $.ajax({\r\n        type: \"GET\",\r\n        url: applyVariables(this.options.singlePageDjvuXmlUrl, this.optionVariables, { pageIndex: index }),\r\n        dataType: this.options.jsonp ? \"jsonp\" : \"html\",\r\n        cache: true,\r\n        error: (e) => undefined,\r\n      });\r\n      try {\r\n        const xmlDoc = $.parseXML(res);\r\n        const result = xmlDoc && $(xmlDoc).find(\"OBJECT\")[0];\r\n        this.pageTextCache.add({ index, response: result });\r\n        return result;\r\n      } catch (e) {\r\n        return undefined;\r\n      }\r\n    } else {\r\n      const XMLpagesArr = await this.djvuPagesPromise;\r\n      if (XMLpagesArr) return XMLpagesArr[index];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Intercept copied text to remove any styling applied to it\r\n   * @param {JQuery} $container\r\n   */\r\n  interceptCopy($container) {\r\n    $container[0].addEventListener('copy', (event) => {\r\n      const selection = document.getSelection();\r\n      event.clipboardData.setData('text/plain', selection.toString());\r\n      event.preventDefault();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Applies mouse events when in default mode\r\n   * @param {HTMLElement} textLayer\r\n   */\r\n  defaultMode(textLayer) {\r\n    const $pageContainer = $(textLayer).closest('.BRpagecontainer');\r\n    textLayer.style.pointerEvents = \"none\";\r\n    $pageContainer.find(\"img\").css(\"pointer-events\", \"auto\");\r\n\r\n    $(textLayer).off(\".textSelectPluginHandler\");\r\n    const startedMouseDown = this.mouseIsDown;\r\n    let skipNextMouseup = this.mouseIsDown;\r\n    if (startedMouseDown) {\r\n      textLayer.style.pointerEvents = \"auto\";\r\n    }\r\n\r\n    // Need to stop propagation to prevent DragScrollable from\r\n    // blocking selection\r\n    $(textLayer).on(\"mousedown.textSelectPluginHandler\", (event) => {\r\n      this.mouseIsDown = true;\r\n      if ($(event.target).is(\".BRwordElement, .BRspace\")) {\r\n        event.stopPropagation();\r\n      }\r\n    });\r\n\r\n    $(textLayer).on(\"mouseup.textSelectPluginHandler\", (event) => {\r\n      this.mouseIsDown = false;\r\n      textLayer.style.pointerEvents = \"none\";\r\n      if (skipNextMouseup) {\r\n        skipNextMouseup = false;\r\n        event.stopPropagation();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * This mode is active while there is a selection on the given textLayer\r\n   * @param {HTMLElement} textLayer\r\n   */\r\n  textSelectingMode(textLayer) {\r\n    const $pageContainer = $(textLayer).closest('.BRpagecontainer');\r\n    // Make text layer consume all events\r\n    textLayer.style.pointerEvents = \"all\";\r\n    // Block img from getting long-press to save while selecting\r\n    $pageContainer.find(\"img\").css(\"pointer-events\", \"none\");\r\n\r\n    $(textLayer).off(\".textSelectPluginHandler\");\r\n\r\n    $(textLayer).on('mousedown.textSelectPluginHandler', (event) => {\r\n      this.mouseIsDown = true;\r\n      event.stopPropagation();\r\n    });\r\n\r\n    // Prevent page flip on click\r\n    $(textLayer).on('mouseup.textSelectPluginHandler', (event) => {\r\n      this.mouseIsDown = false;\r\n      event.stopPropagation();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Initializes text selection modes if there is a text layer on the page\r\n   * @param {JQuery} $container\r\n   */\r\n  stopPageFlip($container) {\r\n    /** @type {JQuery<HTMLElement>} */\r\n    const $textLayer = $container.find('.BRtextLayer');\r\n    if (!$textLayer.length) return;\r\n    $textLayer.each((i, s) => this.defaultMode(s));\r\n    this.interceptCopy($container);\r\n  }\r\n\r\n  /**\r\n   * @param {PageContainer} pageContainer\r\n   */\r\n  async createTextLayer(pageContainer) {\r\n    const pageIndex = pageContainer.page.index;\r\n    const $container = pageContainer.$container;\r\n    const $textLayers = $container.find('.BRtextLayer');\r\n    if ($textLayers.length) return;\r\n    const XMLpage = await this.getPageText(pageIndex);\r\n    if (!XMLpage) return;\r\n    recursivelyAddCoords(XMLpage);\r\n\r\n    const totalWords = $(XMLpage).find(\"WORD\").length;\r\n    if (totalWords > this.maxWordRendered) {\r\n      console.log(`Page ${pageIndex} has too many words (${totalWords} > ${this.maxWordRendered}). Not rendering text layer.`);\r\n      return;\r\n    }\r\n\r\n    const textLayer = createDIVPageLayer(pageContainer.page, 'BRtextLayer');\r\n    const ratioW = parseFloat(pageContainer.$container[0].style.width) / pageContainer.page.width;\r\n    const ratioH = parseFloat(pageContainer.$container[0].style.height) / pageContainer.page.height;\r\n    textLayer.style.transform = `scale(${ratioW}, ${ratioH})`;\r\n    textLayer.setAttribute(\"dir\", this.rtl ? \"rtl\" : \"ltr\");\r\n\r\n    const ocrParagraphs = $(XMLpage).find(\"PARAGRAPH[coords]\").toArray();\r\n    const paragEls = ocrParagraphs.map(p => {\r\n      const el = this.renderParagraph(p);\r\n      textLayer.appendChild(el);\r\n      return el;\r\n    });\r\n\r\n    // Fix up paragraph positions\r\n    const paragraphRects = determineRealRects(textLayer, '.BRparagraphElement');\r\n    let yAdded = 0;\r\n    for (const [ocrParagraph, paragEl] of zip(ocrParagraphs, paragEls)) {\r\n      const ocrParagBounds = $(ocrParagraph).attr(\"coords\").split(\",\").map(parseFloat);\r\n      const realRect = paragraphRects.get(paragEl);\r\n      const [ocrLeft, , ocrRight, ocrTop] = ocrParagBounds;\r\n      const newStartMargin = this.rtl ? (realRect.right - ocrRight) : (ocrLeft - realRect.left);\r\n      const newTop = ocrTop - (realRect.top + yAdded);\r\n\r\n      paragEl.style[this.rtl ? 'marginRight' : 'marginLeft'] = `${newStartMargin}px`;\r\n      paragEl.style.marginTop = `${newTop}px`;\r\n      yAdded += newTop;\r\n      textLayer.appendChild(paragEl);\r\n    }\r\n    $container.append(textLayer);\r\n    this.stopPageFlip($container);\r\n  }\r\n\r\n  /**\r\n   * @param {HTMLElement} ocrParagraph\r\n   * @returns {HTMLParagraphElement}\r\n   */\r\n  renderParagraph(ocrParagraph) {\r\n    const paragEl = document.createElement('p');\r\n    paragEl.classList.add('BRparagraphElement');\r\n    const [paragLeft, paragBottom, paragRight, paragTop] = $(ocrParagraph).attr(\"coords\").split(\",\").map(parseFloat);\r\n    const wordHeightArr = [];\r\n    const lines = $(ocrParagraph).find(\"LINE[coords]\").toArray();\r\n    if (!lines.length) return paragEl;\r\n\r\n\r\n    for (const [prevLine, line, nextLine] of lookAroundWindow(genMap(lines, augmentLine))) {\r\n      const isLastLineOfParagraph = line.ocrElement == lines[lines.length - 1];\r\n      const lineEl = document.createElement('span');\r\n      lineEl.classList.add('BRlineElement');\r\n\r\n      for (const [wordIndex, currWord] of line.words.entries()) {\r\n        const [, bottom, right, top] = $(currWord).attr(\"coords\").split(',').map(parseFloat);\r\n        const wordHeight = bottom - top;\r\n        wordHeightArr.push(wordHeight);\r\n\r\n        if (wordIndex == 0 && prevLine?.lastWord.textContent.trim().endsWith('-')) {\r\n          // ideally prefer the next line to determine the left position,\r\n          // since the previous line could be the first line of the paragraph\r\n          // and hence have an incorrectly indented first word.\r\n          // E.g. https://archive.org/details/driitaleofdaring00bachuoft/page/360/mode/2up\r\n          const [newLeft, , , ] = $((nextLine || prevLine).firstWord).attr(\"coords\").split(',').map(parseFloat);\r\n          $(currWord).attr(\"coords\", `${newLeft},${bottom},${right},${top}`);\r\n        }\r\n\r\n        const wordEl = document.createElement('span');\r\n        wordEl.setAttribute(\"class\", \"BRwordElement\");\r\n        wordEl.textContent = currWord.textContent.trim();\r\n\r\n        if (wordIndex > 0) {\r\n          const space = document.createElement('span');\r\n          space.classList.add('BRspace');\r\n          space.textContent = ' ';\r\n          lineEl.append(space);\r\n\r\n          // Edge ignores empty elements (like BRspace), so add another\r\n          // space to ensure Edge's ReadAloud works correctly.\r\n          lineEl.appendChild(document.createTextNode(' '));\r\n        }\r\n\r\n        lineEl.appendChild(wordEl);\r\n      }\r\n\r\n      const hasHyphen = line.lastWord.textContent.trim().endsWith('-');\r\n      const lastWordEl = lineEl.children[lineEl.children.length - 1];\r\n      if (hasHyphen && !isLastLineOfParagraph) {\r\n        lastWordEl.textContent = lastWordEl.textContent.trim().slice(0, -1);\r\n        lastWordEl.classList.add('BRwordElement--hyphen');\r\n      }\r\n\r\n      paragEl.appendChild(lineEl);\r\n      if (!isLastLineOfParagraph && !hasHyphen) {\r\n        // Edge does not correctly have spaces between the lines.\r\n        paragEl.appendChild(document.createTextNode(' '));\r\n      }\r\n    }\r\n\r\n    wordHeightArr.sort((a, b) => a - b);\r\n    const paragWordHeight = wordHeightArr[Math.floor(wordHeightArr.length * 0.85)] + 4;\r\n    paragEl.style.left = `${paragLeft}px`;\r\n    paragEl.style.top = `${paragTop}px`;\r\n    paragEl.style.width = `${paragRight - paragLeft}px`;\r\n    paragEl.style.height = `${paragBottom - paragTop}px`;\r\n    paragEl.style.fontSize = `${paragWordHeight}px`;\r\n\r\n    // Fix up sizes - stretch/crush words as necessary using letter spacing\r\n    let wordRects = determineRealRects(paragEl, '.BRwordElement');\r\n    const ocrWords = $(ocrParagraph).find(\"WORD\").toArray();\r\n    const wordEls = paragEl.querySelectorAll('.BRwordElement');\r\n    for (const [ocrWord, wordEl] of zip(ocrWords, wordEls)) {\r\n      const realRect = wordRects.get(wordEl);\r\n      const [left, , right ] = $(ocrWord).attr(\"coords\").split(',').map(parseFloat);\r\n      let ocrWidth = right - left;\r\n      // Some books (eg theworksofplato01platiala) have a space _inside_ the <WORD>\r\n      // element. That makes it impossible to determine the correct positining\r\n      // of everything, but to avoid the BRspace's being width 0, which makes selection\r\n      // janky on Chrome Android, assume the space is the same width as one of the\r\n      // letters.\r\n      if (ocrWord.textContent.endsWith(' ')) {\r\n        ocrWidth = ocrWidth * (ocrWord.textContent.length - 1) / ocrWord.textContent.length;\r\n      }\r\n      const diff = ocrWidth - realRect.width;\r\n      wordEl.style.letterSpacing = `${diff / (ocrWord.textContent.length - 1)}px`;\r\n    }\r\n\r\n    // Stretch/crush lines as necessary using line spacing\r\n    // Recompute rects after letter spacing\r\n    wordRects = determineRealRects(paragEl, '.BRwordElement');\r\n    const spaceRects = determineRealRects(paragEl, '.BRspace');\r\n\r\n    const ocrLines = $(ocrParagraph).find(\"LINE[coords]\").toArray();\r\n    const lineEls = Array.from(paragEl.querySelectorAll('.BRlineElement'));\r\n\r\n    let ySoFar = paragTop;\r\n    for (const [ocrLine, lineEl] of zip(ocrLines, lineEls)) {\r\n      // shift words using marginLeft to align with the correct x position\r\n      const words = $(ocrLine).find(\"WORD\").toArray();\r\n      // const ocrLineLeft = Math.min(...words.map(w => parseFloat($(w).attr(\"coords\").split(',')[0])));\r\n      let xSoFar = this.rtl ? paragRight : paragLeft;\r\n      for (const [ocrWord, wordEl] of zip(words, lineEl.querySelectorAll('.BRwordElement'))) {\r\n        // start of line, need to compute the offset relative to the OCR words\r\n        const wordRect = wordRects.get(wordEl);\r\n        const [ocrLeft, , ocrRight ] = $(ocrWord).attr(\"coords\").split(',').map(parseFloat);\r\n        const diff = (this.rtl ? -(ocrRight - xSoFar) : ocrLeft - xSoFar);\r\n\r\n        if (wordEl.previousElementSibling) {\r\n          const space = wordEl.previousElementSibling;\r\n          space.style.letterSpacing = `${diff - spaceRects.get(space).width}px`;\r\n        } else {\r\n          wordEl.style[this.rtl ? 'paddingRight' : 'paddingLeft'] = `${diff}px`;\r\n        }\r\n        if (this.rtl) xSoFar -= diff + wordRect.width;\r\n        else xSoFar += diff + wordRect.width;\r\n      }\r\n      // And also fix y position\r\n      const ocrLineTop = Math.min(...words.map(w => parseFloat($(w).attr(\"coords\").split(',')[3])));\r\n      const diff = ocrLineTop - ySoFar;\r\n      if (lineEl.previousElementSibling) {\r\n        lineEl.previousElementSibling.style.lineHeight = `${diff}px`;\r\n        ySoFar += diff;\r\n      }\r\n    }\r\n\r\n    // The last line will have a line height subtracting from the paragraph height\r\n    lineEls[lineEls.length - 1].style.lineHeight = `${paragBottom - ySoFar}px`;\r\n\r\n    // Edge does not include a newline for some reason when copying/pasting the <p> els\r\n    paragEl.appendChild(document.createElement('br'));\r\n    return paragEl;\r\n  }\r\n}\r\n\r\nexport class BookreaderWithTextSelection extends BookReader {\r\n  init() {\r\n    const options = Object.assign({}, DEFAULT_OPTIONS, this.options.plugins.textSelection);\r\n    if (options.enabled) {\r\n      this.textSelectionPlugin = new TextSelectionPlugin(options, this.options.vars, this.pageProgression);\r\n      // Write this back; this way the plugin is the source of truth, and BR just\r\n      // contains a reference to it.\r\n      this.options.plugins.textSelection = options;\r\n      this.textSelectionPlugin.init();\r\n\r\n      new SelectionObserver('.BRtextLayer', (selectEvent) => {\r\n        // Track how often selection is used\r\n        if (selectEvent == 'started') {\r\n          this.archiveAnalyticsSendEvent?.('BookReader', 'SelectStart');\r\n\r\n          // Set a class on the page to avoid hiding it when zooming/etc\r\n          this.refs.$br.find('.BRpagecontainer--hasSelection').removeClass('BRpagecontainer--hasSelection');\r\n          $(window.getSelection().anchorNode).closest('.BRpagecontainer').addClass('BRpagecontainer--hasSelection');\r\n        }\r\n      }).attach();\r\n    }\r\n\r\n    super.init();\r\n  }\r\n\r\n  /**\r\n   * @param {number} index\r\n   */\r\n  _createPageContainer(index) {\r\n    const pageContainer = super._createPageContainer(index);\r\n    // Disable if thumb mode; it's too janky\r\n    // .page can be null for \"pre-cover\" region\r\n    if (this.mode !== this.constModeThumb && pageContainer.page) {\r\n      this.textSelectionPlugin?.createTextLayer(pageContainer);\r\n    }\r\n    return pageContainer;\r\n  }\r\n}\r\nwindow.BookReader = BookreaderWithTextSelection;\r\nexport default BookreaderWithTextSelection;\r\n\r\n\r\n/**\r\n * @param {HTMLElement} parentEl\r\n * @param {string} selector\r\n * @returns {Map<Element, Rect>}\r\n */\r\nfunction determineRealRects(parentEl, selector) {\r\n  const initals = {\r\n    position: parentEl.style.position,\r\n    visibility: parentEl.style.visibility,\r\n    top: parentEl.style.top,\r\n    left: parentEl.style.left,\r\n    transform: parentEl.style.transform,\r\n  };\r\n  parentEl.style.position = 'absolute';\r\n  parentEl.style.visibility = 'hidden';\r\n  parentEl.style.top = '0';\r\n  parentEl.style.left = '0';\r\n  parentEl.style.transform = 'none';\r\n  document.body.appendChild(parentEl);\r\n  const rects = new Map(\r\n    Array.from(parentEl.querySelectorAll(selector))\r\n      .map(wordEl => {\r\n        const origRect = wordEl.getBoundingClientRect();\r\n        return [wordEl, new Rect(\r\n          origRect.left + window.scrollX,\r\n          origRect.top + window.scrollY,\r\n          origRect.width,\r\n          origRect.height,\r\n        )];\r\n      })\r\n  );\r\n  document.body.removeChild(parentEl);\r\n  Object.assign(parentEl.style, initals);\r\n  return rects;\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} line\r\n */\r\nfunction augmentLine(line) {\r\n  const words = $(line).find(\"WORD\").toArray();\r\n  return {\r\n    ocrElement: line,\r\n    words,\r\n    firstWord: words[0],\r\n    lastWord: words[words.length - 1],\r\n  };\r\n}\r\n\r\n/**\r\n * @template TFrom, TTo\r\n * Generator version of map\r\n * @param {Iterable<TFrom>} gen\r\n * @param {function(TFrom): TTo} fn\r\n * @returns {Iterable<TTo>}\r\n */\r\nexport function* genMap(gen, fn) {\r\n  for (const x of gen) yield fn(x);\r\n}\r\n\r\n/**\r\n * @template T\r\n * Generator that provides a sliding window of 3 elements,\r\n * prev, current, and next.\r\n * @param {Iterable<T>} gen\r\n * @returns {Iterable<[T | undefined, T, T | undefined]>}\r\n */\r\nexport function* lookAroundWindow(gen) {\r\n  let prev = undefined;\r\n  let cur = undefined;\r\n  let next = undefined;\r\n  for (const x of gen) {\r\n    if (typeof cur !== 'undefined') {\r\n      next = x;\r\n      yield [prev, cur, next];\r\n    }\r\n    prev = cur;\r\n    cur = x;\r\n    next = undefined;\r\n  }\r\n\r\n  if (typeof cur !== 'undefined') {\r\n    yield [prev, cur, next];\r\n  }\r\n}\r\n\r\n/**\r\n * @template T1, T2\r\n * Lazy zip implementation to avoid importing lodash\r\n * Expects iterators to be of the same length\r\n * @param {Iterable<T1>} gen1\r\n * @param {Iterable<T2>} gen2\r\n * @returns {Iterable<[T1, T2]>}\r\n */\r\nexport function* zip(gen1, gen2) {\r\n  const it1 = gen1[Symbol.iterator]();\r\n  const it2 = gen2[Symbol.iterator]();\r\n  while (true) {\r\n    const r1 = it1.next();\r\n    const r2 = it2.next();\r\n    if (r1.done && r2.done) {\r\n      return;\r\n    }\r\n    if (r1.done || r2.done) {\r\n      throw new Error('zip: one of the iterators is done');\r\n    }\r\n    yield [r1.value, r2.value];\r\n  }\r\n}\r\n\r\n/**\r\n * [left, bottom, right, top]\r\n * @param {Array<[number, number, number, number]>} bounds\r\n * @returns {[number, number, number, number]}\r\n */\r\nfunction determineBounds(bounds) {\r\n  let leftMost = Infinity;\r\n  let bottomMost = -Infinity;\r\n  let rightMost = -Infinity;\r\n  let topMost = Infinity;\r\n\r\n  for (const [left, bottom, right, top] of bounds) {\r\n    leftMost = Math.min(leftMost, left);\r\n    bottomMost = Math.max(bottomMost, bottom);\r\n    rightMost = Math.max(rightMost, right);\r\n    topMost = Math.min(topMost, top);\r\n  }\r\n\r\n  return [leftMost, bottomMost, rightMost, topMost];\r\n}\r\n\r\n/**\r\n * Recursively traverses the XML tree and adds coords\r\n * which are the bounding box of all child coords\r\n * @param {Element} xmlEl\r\n */\r\nfunction recursivelyAddCoords(xmlEl) {\r\n  if ($(xmlEl).attr('coords') || !xmlEl.children) {\r\n    return;\r\n  }\r\n\r\n  const children = $(xmlEl).children().toArray();\r\n  if (children.length === 0) {\r\n    return;\r\n  }\r\n\r\n  for (const child of children) {\r\n    recursivelyAddCoords(child);\r\n  }\r\n\r\n  const childCoords = [];\r\n\r\n  for (const child of children) {\r\n    if (!$(child).attr('coords')) continue;\r\n    childCoords.push($(child).attr('coords').split(',').map(parseFloat));\r\n  }\r\n\r\n  const boundingCoords = determineBounds(childCoords);\r\n  if (Math.abs(boundingCoords[0]) != Infinity) {\r\n    $(xmlEl).attr('coords', boundingCoords.join(','));\r\n  }\r\n}\r\n\r\n/**\r\n * Basically a polyfill for the native DOMRect class\r\n */\r\nclass Rect {\r\n  /**\r\n   * @param {number} x\r\n   * @param {number} y\r\n   * @param {number} width\r\n   * @param {number} height\r\n   */\r\n  constructor(x, y, width, height) {\r\n    this.x = x;\r\n    this.y = y;\r\n    this.width = width;\r\n    this.height = height;\r\n  }\r\n\r\n  get right() { return this.x + this.width; }\r\n  get bottom() { return this.y + this.height; }\r\n  get top() { return this.y; }\r\n  get left() { return this.x; }\r\n}\r\n","var global = require('../internals/global');\nvar fails = require('../internals/fails');\nvar uncurryThis = require('../internals/function-uncurry-this');\nvar toString = require('../internals/to-string');\nvar trim = require('../internals/string-trim').trim;\nvar whitespaces = require('../internals/whitespaces');\n\nvar charAt = uncurryThis(''.charAt);\nvar n$ParseFloat = global.parseFloat;\nvar Symbol = global.Symbol;\nvar ITERATOR = Symbol && Symbol.iterator;\nvar FORCED = 1 / n$ParseFloat(whitespaces + '-0') !== -Infinity\n  // MS Edge 18- broken with boxed symbols\n  || (ITERATOR && !fails(function () { n$ParseFloat(Object(ITERATOR)); }));\n\n// `parseFloat` method\n// https://tc39.es/ecma262/#sec-parsefloat-string\nmodule.exports = FORCED ? function parseFloat(string) {\n  var trimmedString = trim(toString(string));\n  var result = n$ParseFloat(trimmedString);\n  return result === 0 && charAt(trimmedString, 0) == '-' ? -0 : result;\n} : n$ParseFloat;\n","var PROPER_FUNCTION_NAME = require('../internals/function-name').PROPER;\nvar fails = require('../internals/fails');\nvar whitespaces = require('../internals/whitespaces');\n\nvar non = '\\u200B\\u0085\\u180E';\n\n// check that a method works with the correct list\n// of whitespaces and has a correct name\nmodule.exports = function (METHOD_NAME) {\n  return fails(function () {\n    return !!whitespaces[METHOD_NAME]()\n      || non[METHOD_NAME]() !== non\n      || (PROPER_FUNCTION_NAME && whitespaces[METHOD_NAME].name !== METHOD_NAME);\n  });\n};\n","var $ = require('../internals/export');\nvar $parseFloat = require('../internals/number-parse-float');\n\n// `parseFloat` method\n// https://tc39.es/ecma262/#sec-parsefloat-string\n$({ global: true, forced: parseFloat != $parseFloat }, {\n  parseFloat: $parseFloat\n});\n","'use strict';\nvar $ = require('../internals/export');\nvar $trim = require('../internals/string-trim').trim;\nvar forcedStringTrimMethod = require('../internals/string-trim-forced');\n\n// `String.prototype.trim` method\n// https://tc39.es/ecma262/#sec-string.prototype.trim\n$({ target: 'String', proto: true, forced: forcedStringTrimMethod('trim') }, {\n  trim: function trim() {\n    return $trim(this);\n  }\n});\n"],"names":["SelectionObserver","selector","handler","sel","window","getSelection","selecting","toString","target","$","anchorNode","closest","isCollapsed","this","document","addEventListener","_onSelectionChange","removeEventListener","applyVariables","template","vars","overrides","possibleFilters","APPLY_FILTERS","replace","$0","$1","split","map","x","trim","varName","filterNames","value","n","reduce","acc","cur","urlencode","encodeURIComponent","genMap","lookAroundWindow","zip","BookReader","DEFAULT_OPTIONS","enabled","fullDjvuXmlUrl","singlePageDjvuXmlUrl","jsonp","override","Cache","maxSize","entries","entry","length","shift","push","TextSelectionPlugin","options","optionVariables","pageProgression","type","textSelectingMode","Error","defaultMode","djvuPagesPromise","rtl","pageTextCache","maxWordRendered","selectionObserver","undefined","attach","ajax","url","dataType","cache","error","e","then","res","xmlMap","parseXML","find","index","cachedEntry","response","pageIndex","xmlDoc","result","add","XMLpagesArr","$container","event","selection","clipboardData","setData","preventDefault","textLayer","$pageContainer","style","pointerEvents","css","off","startedMouseDown","mouseIsDown","skipNextMouseup","on","is","stopPropagation","$textLayer","each","i","s","interceptCopy","pageContainer","page","getPageText","XMLpage","recursivelyAddCoords","totalWords","console","log","createDIVPageLayer","ratioW","parseFloat","width","ratioH","height","transform","setAttribute","ocrParagraphs","toArray","paragEls","p","el","renderParagraph","appendChild","paragraphRects","determineRealRects","yAdded","ocrParagraph","paragEl","ocrParagBounds","attr","realRect","get","ocrLeft","ocrRight","ocrTop","newStartMargin","right","left","newTop","top","marginTop","append","stopPageFlip","createElement","classList","paragLeft","paragBottom","paragRight","paragTop","wordHeightArr","lines","augmentLine","prevLine","line","nextLine","isLastLineOfParagraph","ocrElement","lineEl","words","wordIndex","currWord","bottom","wordHeight","lastWord","textContent","endsWith","newLeft","firstWord","wordEl","space","createTextNode","hasHyphen","lastWordEl","children","slice","sort","a","b","paragWordHeight","Math","floor","fontSize","wordRects","querySelectorAll","ocrWord","ocrWidth","diff","letterSpacing","spaceRects","ocrLines","lineEls","Array","from","ySoFar","ocrLine","xSoFar","wordRect","previousElementSibling","min","w","lineHeight","BookreaderWithTextSelection","Object","assign","plugins","textSelection","textSelectionPlugin","init","selectEvent","archiveAnalyticsSendEvent","refs","$br","removeClass","addClass","mode","constModeThumb","createTextLayer","parentEl","initals","position","visibility","body","rects","Map","origRect","getBoundingClientRect","Rect","scrollX","scrollY","removeChild","gen","fn","f","prev","next","gen1","gen2","it1","Symbol","iterator","it2","r1","r2","done","xmlEl","childCoords","child","boundingCoords","bounds","leftMost","Infinity","bottomMost","rightMost","topMost","max","determineBounds","abs","join","y","global","fails","uncurryThis","whitespaces","charAt","n$ParseFloat","ITERATOR","FORCED","module","exports","string","trimmedString","PROPER_FUNCTION_NAME","METHOD_NAME","name","$parseFloat","forced","$trim","proto","forcedStringTrimMethod"],"sourceRoot":""}